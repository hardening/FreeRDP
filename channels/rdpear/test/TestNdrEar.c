#include "../ndr.h"
#include "../rdpear_common.h"

int TestNdrEar(int argc, char* argv[])
{
	int retCode = -2;
	NdrContext* context = ndr_context_new(FALSE, 1);
	if (!context)
		return -1;

	BYTE payload[] = {
		0x00, 0x00, 0x00, 0x00, // (PduType)
		0x02, 0x00, 0x00, 0x00, // (Length)
		0x28, 0x00, 0x02, 0x00, // (Asn1Buffer)

		// == conformant array ==
		0x02, 0x00, 0x00, 0x00, // (nitems)
		0x30, 0x00,             // content
		0x00, 0x00              // (padding)
	};
	wStream staticS;
	wStream* s = Stream_StaticInit(&staticS, payload, sizeof(payload));

	KERB_ASN1_DATA asn1 = { 0 };
	if (!ndr_read_KERB_ASN1_DATA(context, s, NULL, &asn1))
		goto out;
	KERB_ASN1_DATA_destroy(context, &asn1);
	ndr_context_reset(context);

	/* ====================================================================== */
	BYTE payload2[] = {
		// ------------ a RPC_UNICODE_STRING: Administrateur -------------------------
		0x1c, 0x00,             // (Length)
		0x1e, 0x00,             // (MaximumLength)
		0x1c, 0x00, 0x02, 0x00, // (Buffer ptr)
		                        // == conformant array ==
		0x0f, 0x00, 0x00, 0x00, // (maximum count)
		0x00, 0x00, 0x00, 0x00, // (offset)
		0x0e, 0x00, 0x00, 0x00, // (length)

		0x48, 0x00, 0x41, 0x00, 0x52, 0x00, 0x44, 0x00, 0x45, 0x00, 0x4e, 0x00, 0x49, 0x00, 0x4e,
		0x00, 0x47, 0x00, 0x33, 0x00, 0x2e, 0x00, 0x43, 0x00, 0x4f, 0x00, 0x4d, 0x00
	};
	retCode = -3;

	s = Stream_StaticInit(&staticS, payload2, sizeof(payload2));
	RPC_UNICODE_STRING unicode = { 0 };
	if (!ndr_read_RPC_UNICODE_STRING(context, s, NULL, &unicode))
		goto out;
	RPC_UNICODE_STRING_destroy(context, &unicode);
	ndr_context_reset(context);

	/* ====================================================================== */
	BYTE payload3[] = {
		// ------------ an KERB_RPC_INTERNAL_NAME: HARDENING3.COM -------------------------
		0x01, 0x00,             // (NameType)
		0x01, 0x00,             // (NameCount)
		0x10, 0x00, 0x02, 0x00, // (Names)
		                        // == conformant array ==
		0x01, 0x00, 0x00, 0x00, // (nitems)

		// = RPC_UNICODE_STRING =
		0x1c, 0x00,             // (Length)
		0x1e, 0x00,             // (MaximumLength)
		0x14, 0x00, 0x02, 0x00, /// (Buffer ptr)
		                        // == Uni-dimensional Conformant-varying Array ==
		0x0f, 0x00, 0x00, 0x00, // (maximum count)
		0x00, 0x00, 0x00, 0x00, // (offset)
		0x0e, 0x00, 0x00, 0x00, // (length)
		0x41, 0x00, 0x64, 0x00, 0x6d, 0x00, 0x69, 0x00, 0x6e, 0x00, 0x69, 0x00, 0x73, 0x00, 0x74,
		0x00, 0x72, 0x00, 0x61, 0x00, 0x74, 0x00, 0x65, 0x00, 0x75, 0x00, 0x72, 0x00
	};
	KERB_RPC_INTERNAL_NAME intName = { 0 };
	retCode = -4;

	s = Stream_StaticInit(&staticS, payload3, sizeof(payload3));
	if (!ndr_read_KERB_RPC_INTERNAL_NAME(context, s, NULL, &intName))
		goto out;
	KERB_RPC_INTERNAL_NAME_destroy(context, &intName);
	ndr_context_reset(context);

	/* ====================================================================== */
	BYTE payload4[] = {
			0x04, 0x00, 0x02, 0x00, // (EncryptionKey ptr)
			0xf8, 0xca, 0x95, 0x11, // (SequenceNumber)
			0x0c, 0x00, 0x02, 0x00, // (ClientName ptr)
			0x18, 0x00, 0x02, 0x00, // (ClientRealm ptr)
			0x20, 0x00, 0x02, 0x00, // (SkewTime ptr)
			0x00, 0x00, 0x00, 0x00, // (SubKey ptr)
			0x24, 0x00, 0x02, 0x00, // (AuthData ptr)
			0x2c, 0x00, 0x02, 0x00, //(GssChecksum ptr)
			0x07, 0x00, 0x00, 0x00, // (KeyUsage)

			// === EncryptionKey ===
			0x40, 0xe9, 0x12, 0xdf, // reserved1
			0x12, 0x00, 0x00, 0x00, // reserved2
			    // KERB_RPC_OCTET_STRING
				0x4c, 0x00, 0x00, 0x00, // (length)
				0x08, 0x00, 0x02, 0x00, // (value ptr)
			    // == conformant array ==
				0x4c, 0x00, 0x00, 0x00, // (length)
				0xc4, 0x41, 0xee, 0x34,
				0x82, 0x2b, 0x29, 0x61, 0xe2, 0x96, 0xb5, 0x75, 0x61, 0x2d, 0xbf, 0x86, 0x01, 0x00, 0x00, 0x00,
				0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x89, 0x08, 0x60, 0x2e,
				0x30, 0x3e, 0xfe, 0x56, 0x11, 0xf0, 0x31, 0xf2, 0xd6, 0x2e, 0x3d, 0x33, 0xfe, 0xce, 0x56, 0x12,
				0xbf, 0xb2, 0xe5, 0x86, 0x29, 0x8d, 0x29, 0x74, 0x1f, 0x8a, 0xf9, 0xb9, 0x8c, 0xd4, 0x86, 0x3a,
				0x21, 0x92, 0xb2, 0x07, 0x95, 0x4b, 0xea, 0xee,

			//=== ClientName - KERB_RPC_INTERNAL_NAME ===
			0x01, 0x00, // (NameType)
			0x01, 0x00, // (NameCount)
			0x10, 0x00, 0x02, 0x00, // (Names)
			    // == conformant array ==
				0x01, 0x00, 0x00, 0x00, // (nitems)

			    // = RPC_UNICODE_STRING =
				0x1c, 0x00, // (Length)
				0x1e, 0x00, // (MaximumLength)
				0x14, 0x00, 0x02, 0x00, //(Buffer ptr)
			    // == Uni-dimensional Conformant-varying Array ==
			    0x0f, 0x00, 0x00, 0x00, // (maximum count)
				0x00, 0x00, 0x00, 0x00, // (offset)
				0x0e, 0x00, 0x00, 0x00, // (length)
				0x41, 0x00, 0x64, 0x00, 0x6d, 0x00, 0x69, 0x00, 0x6e, 0x00, 0x69, 0x00,
				0x73, 0x00, 0x74, 0x00, 0x72, 0x00, 0x61, 0x00, 0x74, 0x00, 0x65, 0x00,
				0x75, 0x00, 0x72, 0x00,

			// === ClientRealm - RPC_UNICODE_STRING ===
			0x1c, 0x00, // (Length)
			0x1e, 0x00, // (MaximumLength)
			0x1c, 0x00, 0x02, 0x00, // (Buffer ptr)
			    // == conformant array ==
				0x0f, 0x00, 0x00, 0x00, // (maximum count)
				0x00, 0x00, 0x00, 0x00, // (offset)
				0x0e, 0x00, 0x00, 0x00, // (length)
				0x48, 0x00, 0x41, 0x00, 0x52, 0x00, 0x44, 0x00, 0x45, 0x00, 0x4e, 0x00,
				0x49, 0x00, 0x4e, 0x00, 0x47, 0x00, 0x33, 0x00, 0x2e, 0x00, 0x43, 0x00,
				0x4f, 0x00, 0x4d, 0x00,

			// == SkewTime ==
			0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00,

			// == SubKey ==
			0x00, 0x00, 0x00, 0x00,

			// === AuthData - KERB_ASN1_DATA ==
			0x00, 0x00, 0x00, 0x00, // (PduType)
			0x02, 0x00, 0x00, 0x00, // (Length)
			0x28, 0x00, 0x02, 0x00, // (Asn1Buffer)
			    // == conformant array ==
				0x02, 0x00, 0x00, 0x00, // (nitems)
				0x30, 0x00,
				0x00, 0x00, // (padding)

			// === GssChecksum - KERB_ASN1_DATA ===
			0x08, 0x00, 0x00, 0x00, // (PduType)
			0x1b, 0x00, 0x00, 0x00, // (Length)
			0x30, 0x00, 0x02, 0x00, // (Asn1Buffer)
			    // == conformant array ==
				0x1b, 0x00, 0x00, 0x00, // (length)
				0x30, 0x19,
					0xa0, 0x03,
						0x02, 0x01, 0x07,
					0xa1, 0x12,
			            0x04, 0x10, 0xb9, 0x4f, 0xcd, 0xae, 0xd9, 0xa8, 0xff, 0x49, 0x69, 0x5a, 0xd1,
						0x1d, 0x38, 0x49, 0xb6, 0x92, 0x00
	};
	CreateApReqAuthenticatorReq createApReqAuthenticatorReq = { 0 };
	s = Stream_StaticInit(&staticS, payload4, sizeof(payload4));
	if (!ndr_read_CreateApReqAuthenticatorReq(context, s, &createApReqAuthenticatorReq) ||
		!ndr_treat_deferred(context, s))
		goto out;
	CreateApReqAuthenticatorReq_destroy(context, &createApReqAuthenticatorReq);
	ndr_context_reset(context);

	retCode = 0;
out:
	ndr_context_destroy(&context);
	return retCode;
}
